<div class="container py-4">
  <div class="row">
    <div class="col-12 col-md-7 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="card-title mb-3">Datos de envío</h4>

          <form [formGroup]="shippingForm" (ngSubmit)="$event.preventDefault()">
            <div class="mb-2">
              <label class="form-label">Nombre y apellidos</label>
              <input class="form-control" formControlName="nombre" placeholder="Ej. Carlos González" />
              <div class="text-danger small" *ngIf="shippingForm.get('nombre')?.invalid && shippingForm.get('nombre')?.touched">
                Nombre obligatorio.
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Dirección</label>
              <input class="form-control" formControlName="direccion" placeholder="Calle, número, piso..." />
            </div>

            <div class="row">
              <div class="col-7 mb-2">
                <label class="form-label">Ciudad</label>
                <input class="form-control" formControlName="ciudad" />
              </div>
              <div class="col-5 mb-2">
                <label class="form-label">Código postal</label>
                <input class="form-control" formControlName="cp" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Teléfono</label>
              <input class="form-control" formControlName="telefono" />
            </div>
          </form>

          <hr />

          <h5 class="mb-2">Método de pago</h5>

          <!-- Contenedor del formGroup de pago -->
          <div [formGroup]="paymentForm" class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                id="payCard"
                formControlName="metodo"
                name="metodo"
                value="card"
              />
              <label class="form-check-label" for="payCard">Tarjeta (simulado)</label>
            </div>

            <div class="ps-4 mt-2" *ngIf="paymentForm.get('metodo')?.value === 'card'">
              <div class="mb-2">
                <input class="form-control" placeholder="Número de tarjeta" formControlName="cardNumber" />
              </div>
              <div class="row">
                <div class="col-6 mb-2">
                  <input class="form-control" placeholder="MM/AA" formControlName="cardExp" />
                </div>
                <div class="col-6 mb-2">
                  <input class="form-control" placeholder="CVC" formControlName="cardCvc" />
                </div>
              </div>
              <div class="small text-muted">La entrada es simulada — en producción integra Stripe/Checkout u otro proveedor.</div>
            </div>

            <div class="form-check mt-2">
              <input
                class="form-check-input"
                type="radio"
                id="payCod"
                formControlName="metodo"
                name="metodo"
                value="cod"
              />
              <label class="form-check-label" for="payCod">Pago contra entrega</label>
            </div>
          </div>

          <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" (click)="backToCart()" [disabled]="loading">Volver al carrito</button>
            <button class="btn btn-primary ms-auto" (click)="submitOrder()" [disabled]="loading">
              <span *ngIf="!loading">Pagar {{ total | number:'1.2-2' }} MXN</span>
              <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: resumen de pedido -->
    <div class="col-12 col-md-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Resumen del pedido</h5>

          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between align-items-start" *ngFor="let it of (items$ | async)">
              <div class="me-auto">
                <div class="fw-semibold">{{ it.title }}</div>
                <small class="text-muted">x{{ it.qty }} · {{ it.price | number:'1.2-2' }} MXN</small>
              </div>
              <div class="text-end">
                <div class="fw-semibold">{{ (it.price * it.qty) | number:'1.2-2' }} MXN</div>
              </div>
            </li>

            <li class="list-group-item d-flex justify-content-between">
              <span>Subtotal</span>
              <strong>{{ total | number:'1.2-2' }} MXN</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Envío</span>
              <span class="text-muted">A calcular</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>IVA (incl.)</span>
              <span class="text-muted">Incluido</span>
            </li>
          </ul>

          <div class="text-center">
            <small class="text-muted">Al hacer clic en "Pagar" confirmarás el pedido y serás redirigido a la confirmación.</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>